plugins {
    id("dev.kikugie.stonecutter") version "0.8.2"
    alias(libs.plugins.arch.loom)
}
apply from: rootProject.file('buildscript/standalone.gradle')

configurations.configureEach {
    resolutionStrategy {
        force "org.slf4j:slf4j-api:1.7.36" // Introduced by Minecraft itself
    }
}

java {
    def version = Integer.parseInt(project.property("deps.java"))
    def javaVersion = version > 10
            ? JavaVersion.valueOf("VERSION_" + version)
            : JavaVersion.valueOf("VERSION_1_" + version)

    targetCompatibility = javaVersion
    sourceCompatibility = javaVersion
}

if(project.path.startsWith(":fabric:")) {
    tasks.register('deleteMappedSrc', Delete) {
        delete project.file("src")
    }

    clean.dependsOn deleteMappedSrc
}

sourceSets {
    main {
        java {
            srcDirs("versions/${sc.current.version}/src/main/java")
        }
        resources {
            srcDirs("versions/${sc.current.version}/src/main/resources")
        }
    }
}

processResources {
    def version = project.version
    def loaderVersion = project.property("deps.fabric_loader")
    def minecraftVersion = sc.current.version

    inputs.property("version", version)
    inputs.property("loaderVersion", loaderVersion)
    inputs.property("minecraftVersion", minecraftVersion)

    filesMatching("fabric.mod.json") {
        expand(
            VERSION:          version,
            LOADER_VERSION:   loaderVersion,
            MINECRAFT_VERSION: minecraftVersion
        )
    }
    dependsOn generateRuntimeDownloadResourceForRuntimeDownloadOnly
}

shadowJar {
    configurations = [project.configurations.shadow]
    mergeServiceFiles()
}

stonecutter {
    replacements.string(sc.current.parsed.matches(">=1.21.11")) {
        replace("ResourceLocation", "Identifier")
        replace(".location()", ".identifier()")
        replace("ResourceKey::location", "ResourceKey::identifier")
    }
}

tasks.register('copyRemappedJar', Copy) {
    from remapJar.archiveFile
    into rootProject.file('jars/fabric')
}

remapJar {
    dependsOn shadowJar
    mustRunAfter shadowJar
    inputFile = shadowJar.archiveFile

    archiveBaseName = "DiscordSRV-Fabric-${sc.current.version}"
    if (sc.current.version == "1.21.6") {
        archiveBaseName = "DiscordSRV-Fabric-${sc.current.version}-1.21.8"
    } else if (sc.current.version == "1.21.9") {
        archiveBaseName = "DiscordSRV-Fabric-${sc.current.version}-1.21.10"
    }
    archiveClassifier = jar.archiveClassifier

    finalizedBy copyRemappedJar
}

spotless {
    java {
        if (sc.current.isActive)
            target("src/main/java/")
    }
}

artifacts {
    archives remapJar
    shadow shadowJar
}

loom {
    serverOnlyMinecraftJar()
    runConfigs.all {
        ideConfigGenerated(true) // Run configurations are not created for subprojects by default
        runDir = "../../run" // Use a shared run folder and create separate worlds
    }
    silentMojangMappingsLicense()
}

repositories {
    exclusiveContent {
        forRepository {
            maven { url = 'https://maven.fabricmc.net/' }
        }
        filter {
            includeGroup 'net.fabricmc'
        }
    }
    exclusiveContent {
        forRepository {
            maven { url = 'https://maven.nucleoid.xyz/' }
        }
        filter {
            includeGroup 'eu.pb4'
        }
    }
}

dependencies {
    minecraft("com.mojang:minecraft:${sc.current.version}")
    mappings(loom.officialMojangMappings())
    compileOnly("net.fabricmc:fabric-loader:${project.property("deps.fabric_loader")}")

    // Fabric API
    Set<String> apiModules = [
            'fabric-api-base',
            'fabric-lifecycle-events-v1',
            'fabric-entity-events-v1',
            'fabric-networking-api-v1',
    ]
//    if (stonecutter.eval(stonecutter.current.version, ">=1.19.2")) apiModules.add('fabric-message-api-v1')
//    if (stonecutter.eval(stonecutter.current.version, "<1.21.9")) apiModules.add('fabric-resource-loader-v0')
    if (sc.current.parsed >= "1.19.2") apiModules.add('fabric-message-api-v1')
    if (sc.current.parsed < "1.21.9") apiModules.add('fabric-resource-loader-v0')
    else apiModules.add('fabric-resource-loader-v1')

    apiModules.forEach {
        modImplementation(fabricApi.module(it, project.property("deps.fabric_api")))
    }

    // Minecraft versions under 1.21.6 should use 0.3.3, while 1.21.6 and above should use 0.4.1
    modImplementation("me.lucko:fabric-permissions-api:${sc.current.parsed >= "1.21.6" ? '0.4.1' : '0.3.3'}") {
        exclude group: 'net.fabricmc.fabric-api', module: 'fabric-api-base'
        exclude group: 'net.fabricmc.fabric-api', module: 'fabric-api-bom'
    }
    include ("me.lucko:fabric-permissions-api:${sc.current.parsed >= "1.21.6" ? '0.4.1' : '0.3.3'}")

    // API
    annotationProcessor project(':api')
    shadow project(':common:common-api')

    // Common
    shadow project(':common')
    implementation project(':modded')

    // Adventure
    modImplementation("net.kyori:adventure-platform-fabric:${project.property("deps.adventure_platform_fabric")}") {
        exclude group: 'net.kyori', module: 'ansi'
    }
    include("net.kyori:adventure-platform-fabric:${project.property("deps.adventure_platform_fabric")}")

    implementation(libs.kyori.ansi)
    include(libs.kyori.ansi)

    // Integrations
    modCompileOnly("eu.pb4:placeholder-api:${project.property("deps.text_placeholder_api")}")

    // DependencyDownload
    shadow(libs.mcdependencydownload.fabric) {
        exclude module: 'fabric-loader'
    }
}
